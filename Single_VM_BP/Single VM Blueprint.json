{"status":{},"contains_secrets":true,"product_version":"3.5.2","spec":{"description":"","resources":{"endpoints_information":[],"endpoint_definition_list":[],"client_attrs":{},"credential_definition_list":[],"runbook":{"task_definition_list":[{"retries":"0","description":"","inherit_target":false,"child_tasks_local_reference_list":[{"kind":"app_task","name":"Precheck Validation"},{"kind":"app_task","name":"Create BP"},{"kind":"app_task","name":"Launch BP"}],"name":"a0c17627_dag","attrs":{"edges":[{"from_task_reference":{"kind":"app_task","name":"Precheck Validation"},"edge_type":"user_defined","type":"","to_task_reference":{"kind":"app_task","name":"Create BP"}},{"from_task_reference":{"kind":"app_task","name":"Create BP"},"edge_type":"user_defined","type":"","to_task_reference":{"kind":"app_task","name":"Launch BP"}}],"type":""},"timeout_secs":"0","type":"DAG","variable_list":[]},{"retries":"0","description":"","inherit_target":false,"child_tasks_local_reference_list":[],"name":"Precheck Validation","attrs":{"exit_status":[],"script":"import requests\nfrom requests.auth import HTTPBasicAuth\nPC_IP = \"@@{PC_IP}@@\"\npc_username = \"@@{prism_central_username}@@\"\npc_password = \"@@{prism_central_passwd}@@\"\n\ndef _build_url(scheme, resource_type, host=PC_IP, **params):\n    _base_url = \"\/api\/nutanix\/v3\"\n    url = \"{proto}:\/\/{host}\".format(proto=scheme, host=host)\n    port = params.get('nutanix_port', '9440')\n    if port:\n        url = url + \":{0}\".format(port) + _base_url\n    if resource_type.startswith(\"\/\"):\n        url += resource_type\n    else:\n        url += \"\/{0}\".format(resource_type)\n    return url\n        \ndef get_project_details(project_name):\n    url = _build_url(scheme=\"https\",\n                    resource_type=\"\/projects\/list\")\n    data = requests.post(url, json={\"kind\":\"project\", \"filter\":\"name==%s\"%project_name},\n                        auth=HTTPBasicAuth(pc_username, pc_password),\n                        timeout=None, verify=False)\n    if data.ok:\n        if data.json()[\"metadata\"][\"total_matches\"] == 1:\n            print(\"project_uuid={}\".format(data.json()[\"entities\"][0][\"metadata\"][\"uuid\"]))\n        else:\n            print(\"Failed to get correct project details. Make sure project name is correct.\")\n            print(data.json().get('message_list',data.json().get('error_detail', data.json())))\n            exit(1)\n    else:\n        print(\"Error in fetching project details.\")\n        print(data.json().get('message_list',data.json().get('error_detail', data.json())))\n        exit(1)\n        \ndef get_cluster_details(cluster_name):\n    payload = {\"kind\": \"cluster\"}\n    url = _build_url(scheme=\"https\",\n                    resource_type=\"\/clusters\/list\")\n    data = requests.post(url, json=payload,\n                         auth=HTTPBasicAuth(pc_username, pc_password), \n                         verify=False)\n    if data.ok:\n        for _cluster in data.json()['entities']:\n            if _cluster['status']['name'] == cluster_name:\n                print(\"cluster_uuid={}\".format(_cluster['metadata']['uuid']))\n                return \n        print(\"Input Error :- Given cluster %s not present on %s\"%(cluster_name, PC_IP))\n        exit(1)\n    else:\n        print(\"Error while fetching %s cluster info\"%cluster_name)\n        print(data.json().get('message_list',data.json().get('error_detail', data.json())))\n        exit(1)\n        \ndef get_subnet_uuid(subnet_name):\n    url = _build_url(scheme=\"https\",resource_type=\"\/subnets\/list\")\n    data = requests.post(url, json={\"kind\":\"subnet\", \"filter\":\"name==%s\"%subnet_name},\n                         auth=HTTPBasicAuth(pc_username, pc_password),\n                         timeout=None, verify=False)\n    if data.ok:\n        if data.json()['metadata']['total_matches'] == 0:\n            print(\"%s not present on %s\"%(subnet_name, PC_IP))\n            exit(1)\n        elif data.json()['metadata']['total_matches'] > 1:\n            print(\"There are more than one subnets with name - %s on - %s\"%(subnet_name, PC_IP))\n            print(\"Please delete it manually before executing runbook.\")\n            exit(1)\n        else:\n            print(\"subnet_uuid={}\".format(data.json()['entities'][0]['metadata']['uuid']))\n            print(\"vpc_uuid={}\".format(data.json()[\"entities\"][0][\"spec\"]\\\n                                [\"resources\"][\"vpc_reference\"][\"uuid\"]))\n    else:\n        print(\"Error while fetching subnet details :- \",data.json().get('message_list',\n                                     data.json().get('error_detail', data.json())))\n        exit(1)\n        \ndef get_image_uuid(image_name):\n    url = _build_url(scheme=\"https\",resource_type=\"\/images\/list\")\n    data = requests.post(url, json={\"kind\":\"image\", \"filter\":\"name==%s\"%image_name},\n                        auth=HTTPBasicAuth(pc_username, pc_password),\n                        timeout=None, verify=False)\n    if data.ok:\n        print(\"image_uuid={}\".format(data.json()['entities'][0]['metadata']['uuid']))\n    else:\n        print(\"Error -- %s Image not present on %s\"%(image_name, PC_IP))\n        exit(1)\n        \ndef get_account_uuid(account_name,cluster_name):\n    url = _build_url(scheme=\"https\",resource_type=\"\/accounts\/list\")\n    data = requests.post(url, json={\"kind\":\"account\"},\n                        auth=HTTPBasicAuth(pc_username, pc_password),\n                        timeout=None, verify=False)       \n    if account_name in str(data.json()):\n        for new_data in data.json()['entities']:\n            if new_data['metadata']['name'] == account_name:\n                for _cluster in new_data[\"status\"][\"resources\"][\"data\"][\"cluster_account_reference_list\"]:\n                    if _cluster[\"resources\"][\"data\"][\"cluster_name\"] == cluster_name:\n                        account_uuid = _cluster[\"uuid\"]\n                        print(\"account_uuid={}\".format(account_uuid))\n    else:\n        print(\"Error : %s account not present on %s\"%(account_name,PC_IP))\n        exit(1)  \n        \ndef get_environment_details(env_name):\n    url = _build_url(scheme=\"https\",resource_type=\"\/environments\/list\")\n    data = requests.post(url, json={\"kind\":\"environment\", \"filter\":\"name==%s\"%env_name},\n                         auth=HTTPBasicAuth(pc_username, pc_password),\n                         timeout=None, verify=False)\n    if data.ok:\n        if data.json()['metadata']['total_matches'] == 0:\n            print(\"%s environment not present on %s\"%(env_name, PC_IP))\n            exit(1)\n        elif data.json()['metadata']['total_matches'] > 1:\n            print(\"There are more than one environment with name - %s on - %s\"%(env_name, PC_IP))\n            exit(1)\n        else:\n            print(\"environment_uuid={}\".format(data.json()['entities'][0]['metadata']['uuid']))\n    else:\n        print(\"Error while fetching environment details :- \",data.json().get('message_list',\n                                     data.json().get('error_detail', data.json())))\n        exit(1)\n\nget_project_details(\"@@{project_name}@@\")\nget_cluster_details(\"@@{cluster_name}@@\")\nget_subnet_uuid(\"@@{subnet_name}@@\")\nget_image_uuid(\"@@{image_name}@@\")\nget_account_uuid(\"@@{account_name}@@\",\"@@{cluster_name}@@\")\nget_environment_details(\"@@{environment_name}@@\")","eval_variables":["project_uuid","cluster_uuid","subnet_uuid","account_uuid","image_uuid","environment_uuid","vpc_uuid"],"eval_scope":"local","type":"","script_type":"static"},"timeout_secs":"0","type":"SET_VARIABLE","variable_list":[]},{"retries":"0","description":"","inherit_target":false,"child_tasks_local_reference_list":[],"name":"Create BP","attrs":{"exit_status":[],"script":"# script\nimport requests\nfrom requests.auth import HTTPBasicAuth\n\nPC_IP = \"@@{PC_IP}@@\"\npc_user = \"@@{prism_central_username}@@\"\npc_password = \"@@{prism_central_passwd}@@\"\n\ndef _build_url(scheme, resource_type, host=PC_IP, **params):\n    _base_url = \"\/api\/nutanix\/v3\"\n    url = \"{proto}:\/\/{host}\".format(proto=scheme, host=host)\n    port = params.get('nutanix_port', '9440')\n    if port:\n        url = url + \":{0}\".format(port) + _base_url\n    if resource_type.startswith(\"\/\"):\n        url += resource_type\n    else:\n        url += \"\/{0}\".format(resource_type)\n    return url\n\ndef get_policy_spec(**params):\n    url = _build_url(scheme=\"https\",\n                    resource_type=\"\/idempotence_identifiers\")\n    data = requests.post(url, json={\"count\": 1,\"valid_duration_in_minutes\": 527040},\n                        auth=HTTPBasicAuth(pc_user, pc_password),\n                        timeout=None, verify=False)                   \n    _uuid = \"\"\n    if data.ok:\n        _uuid = data.json()['uuid_list'][0]\n    else:\n        print(\"Error :- Failed to generate UUID for app_protection_rule\")\n        exit(1)\n    return (\n    {\n    \"api_version\": \"3.0\",\n    \"metadata\": {\n        \"kind\": \"app_protection_policy\",\n        \"project_reference\": {\n            \"kind\": \"project\",\n            \"uuid\": params['project_uuid']\n        }\n    },\n    \"spec\": {\n        \"name\": \"Policy_@@{app_name}@@\",\n        \"description\": \"\",\n        \"resources\": {\n            \"is_default\": True,\n            \"ordered_availability_site_list\": [\n                {\n                    \"environment_reference\": {\n                        \"kind\": \"environment\",\n                        \"uuid\": params['environment']\n                    },\n                    \"infra_inclusion_list\": {\n                        \"type\": \"nutanix_pc\",\n                        \"account_reference\": {\n                            \"kind\": \"account\",\n                            \"uuid\": params['account_uuid']\n                        },\n                        \"cluster_references\": [\n                            {\n                                \"kind\": \"cluster\",\n                                \"uuid\": params['cluster_uuid']\n                            }\n                        ]\n                    }\n                }\n            ],\n            \"app_protection_rule_list\": [\n                {\n                    \"name\": \"rule_@@{app_name}@@\",\n                    \"enabled\": True,\n                    \"local_snapshot_retention_policy\": {\n                        \"snapshot_expiry_policy\": {\n                            \"multiple\": 0\n                        }\n                    },\n                    \"first_availability_site_index\": 0,\n                    \"second_availability_site_index\": 0,\n                    \"uuid\": _uuid\n                }\n            ]\n        }\n    }\n    })\n\ndef protection_policy(**params):\n    payload = get_policy_spec(**params)\n    url = \"https:\/\/%s:9440\/api\/calm\/v3.0\/app_protection_policies\"%PC_IP\n    data = requests.post(url, json=payload,\n                        auth=HTTPBasicAuth(pc_user,pc_password),\n                        timeout=None, verify=False)\n    print(\"protection_policy_uuid={}\".format(data.json()[\"metadata\"][\"uuid\"]))\n    print(\"protection_rule_uuid={}\".format(data.json()[\"spec\"]\\\n                        [\"resources\"][\"app_protection_rule_list\"][0][\"uuid\"]))\n    wait_for_completion(data)\n    \ndef get_spec(**params):\n    url = _build_url(scheme=\"https\",\n                    resource_type=\"\/idempotence_identifiers\")\n    data = requests.post(url, json={\"count\": 25,\"valid_duration_in_minutes\": 527040},\n                        auth=HTTPBasicAuth(pc_user, pc_password),\n                        timeout=None, verify=False)                   \n    _uuid = []\n    if data.ok:\n        _uuid = data.json()['uuid_list']\n        print(\"bp_spec_uuid={}\".format(_uuid))\n    else:\n        print(\"Error :- Failed to generate UUID's for app_protection_rule\")\n        exit(1)\n\n    connection_type = \"POWERSHELL\"\n    connection_port = 5985\n    connection_protocol = \"http\"\n    if \"@@{vm_os}@@\" == \"Linux\":\n        connection_type = \"SSH\"\n        connection_port = 22\n        connection_protocol = \"\"\n        \n    ip_list = []\n    if \"@@{custom_ip_for_vm}@@\".lower() not in [\"\", \"na\", \"none\"]:\n        ip_list = [{\"ip\": \"@@{custom_ip_for_vm}@@\"}]\n        \n    return ({\n    \"api_version\": \"3.0\",\n    \"metadata\": {\n        \"kind\": \"blueprint\",\n        \"categories\": {\n            \"TemplateType\": \"Vm\"\n        },\n        \"project_reference\": {\n            \"kind\": \"project\",\n            \"uuid\": params[\"project_uuid\"]\n        }\n    },\n    \"spec\": {\n        \"resources\": {\n            \"client_attrs\": {},\n            \"type\": \"USER\",\n            \"app_profile_list\": [\n                {\n                    \"name\": \"Default\",\n                    \"action_list\": [],\n                    \"variable_list\": [],\n                    \"deployment_create_list\": [\n                        {\n                            \"variable_list\": [],\n                            \"action_list\": [],\n                            \"min_replicas\": \"1\",\n                            \"name\": \"%s_deployment\"%(_uuid[0].split(\"-\")[-1]),\n                            \"max_replicas\": \"1\",\n                            \"substrate_local_reference\": {\n                                \"kind\": \"app_substrate\",\n                                \"uuid\": _uuid[0]\n                            },\n                            \"default_replicas\": \"1\",\n                            \"type\": \"GREENFIELD\",\n                            \"package_local_reference_list\": [\n                                {\n                                    \"kind\": \"app_package\",\n                                    \"uuid\": _uuid[1]\n                                }\n                            ],\n                            \"uuid\": _uuid[2]\n                        }\n                    ],\n                    \"environment_reference_list\": [\n                        params[\"environment\"]\n                    ],\n                    \"snapshot_config_list\": [],\n                    \"restore_config_list\": [],\n                    \"uuid\": _uuid[3]\n                }\n            ],\n            \"substrate_definition_list\": [\n                {\n                    \"variable_list\": [],\n                    \"type\": \"AHV_VM\",\n                    \"os_type\": \"@@{vm_os}@@\",\n                    \"action_list\": [],\n                    \"create_spec\": {\n                        \"name\": params[\"vm_name\"],\n                        \"resources\": {\n                            \"disk_list\": [\n                                {\n                                    \"data_source_reference\": {\n                                        \"kind\": \"image\",\n                                        \"name\": \"@@{image_name}@@\",\n                                        \"uuid\": params[\"image_uuid\"]\n                                    },\n                                    \"device_properties\": {\n                                        \"device_type\": \"DISK\",\n                                        \"disk_address\": {\n                                            \"device_index\": 0,\n                                            \"adapter_type\": \"SCSI\"\n                                        }\n                                    }\n                                }\n                            ],\n                            \"nic_list\": [\n                                {\n                                    \"subnet_reference\": {\n                                        \"uuid\": params[\"subnet_uuid\"]\n                                    },\n                                    \"ip_endpoint_list\": ip_list,\n                                    \"vpc_reference\": {\n                                        \"uuid\": \"@@{vpc_uuid}@@\"\n                                    }\n                                }\n                            ],\n                            \"boot_config\": {\n                                \"boot_device\": {\n                                    \"disk_address\": {\n                                        \"device_index\": 0,\n                                        \"adapter_type\": \"SCSI\"\n                                    }\n                                },\n                                \"boot_type\": \"LEGACY\"\n                            },\n                            \"account_uuid\": params[\"account_uuid\"],\n                            \"num_sockets\": 1,\n                            \"num_vcpus_per_socket\": @@{vm_vcpus}@@,\n                            \"memory_size_mib\": @@{vm_memory}@@ * 1024\n                        },\n                        \"categories\": @@{tenant_category}@@,\n                        \"cluster_reference\": {\n                            \"uuid\": params[\"cluster_uuid\"]\n                        }\n                    },\n                    \"readiness_probe\": {\n                        \"disable_readiness_probe\": True,\n                        \"address\": \"\",\n                        \"delay_secs\": \"60\",\n                        \"retries\": \"5\",\n                        \"connection_type\": connection_type,\n                        \"connection_port\": connection_port,\n                        \"connection_protocol\": connection_protocol,\n                        \"login_credential_local_reference\": {\n                            \"kind\": \"app_credential\",\n                            \"uuid\": _uuid[4]\n                        }\n                    },\n                    \"name\": params[\"vm_name\"],\n                    \"uuid\": _uuid[0]\n                }\n            ],\n            \"package_definition_list\": [\n                {\n                    \"type\": \"DEB\",\n                    \"variable_list\": [],\n                    \"options\": {\n                        \"install_runbook\": {\n                            \"name\": \"%s_runbook\"%(_uuid[5].split(\"-\")[-1]),\n                            \"variable_list\": [],\n                            \"main_task_local_reference\": {\n                                \"kind\": \"app_task\",\n                                \"uuid\": _uuid[5]\n                            },\n                            \"task_definition_list\": [\n                                {\n                                    \"name\": \"%s_dag\"%(_uuid[1].split(\"-\")[-1]),\n                                    \"target_any_local_reference\": {\n                                        \"kind\": \"app_package\",\n                                        \"uuid\": _uuid[1]\n                                    },\n                                    \"variable_list\": [],\n                                    \"child_tasks_local_reference_list\": [],\n                                    \"type\": \"DAG\",\n                                    \"attrs\": {\n                                        \"edges\": []\n                                    },\n                                    \"uuid\": _uuid[5]\n                                }\n                            ],\n                            \"uuid\": _uuid[6]\n                        },\n                        \"uninstall_runbook\": {\n                            \"name\": \"%s_runbook\"%(_uuid[7].split(\"-\")[-1]),\n                            \"variable_list\": [],\n                            \"main_task_local_reference\": {\n                                \"kind\": \"app_task\",\n                                \"uuid\": _uuid[7]\n                            },\n                            \"task_definition_list\": [\n                                {\n                                    \"name\": \"%s_dag\"%(_uuid[1].split(\"-\")[-1]),\n                                    \"target_any_local_reference\": {\n                                        \"kind\": \"app_package\",\n                                        \"uuid\": _uuid[1]\n                                    },\n                                    \"variable_list\": [],\n                                    \"child_tasks_local_reference_list\": [],\n                                    \"type\": \"DAG\",\n                                    \"attrs\": {\n                                        \"edges\": []\n                                    },\n                                    \"uuid\": _uuid[7]\n                                }\n                            ],\n                            \"uuid\": _uuid[8]\n                        }\n                    },\n                    \"service_local_reference_list\": [\n                        {\n                            \"kind\": \"app_service\",\n                            \"uuid\": _uuid[9]\n                        }\n                    ],\n                    \"name\": \"Package1\",\n                    \"uuid\": _uuid[1]\n                }\n            ],\n            \"service_definition_list\": [\n                {\n                    \"name\": \"Service1\",\n                    \"depends_on_list\": [],\n                    \"variable_list\": [],\n                    \"port_list\": [],\n                    \"action_list\": [\n                        {\n                            \"name\": \"action_create\",\n                            \"runbook\": {\n                                \"name\": \"%s_runbook\"%(_uuid[10].split(\"-\")[-1]),\n                                \"variable_list\": [],\n                                \"main_task_local_reference\": {\n                                    \"kind\": \"app_task\",\n                                    \"uuid\": _uuid[10]\n                                },\n                                \"task_definition_list\": [\n                                    {\n                                        \"name\": \"%s_dag\"%(_uuid[9].split(\"-\")[-1]),\n                                        \"target_any_local_reference\": {\n                                            \"kind\": \"app_service\",\n                                            \"uuid\": _uuid[9]\n                                        },\n                                        \"variable_list\": [],\n                                        \"child_tasks_local_reference_list\": [],\n                                        \"type\": \"DAG\",\n                                        \"attrs\": {\n                                            \"edges\": []\n                                        },\n                                        \"uuid\": _uuid[10]\n                                    }\n                                ],\n                                \"uuid\": _uuid[11]\n                            },\n                            \"type\": \"system\",\n                            \"uuid\": _uuid[12]\n                        },\n                        {\n                            \"name\": \"action_delete\",\n                            \"runbook\": {\n                                \"name\": \"%s_runbook\"%(_uuid[13].split(\"-\")[-1]),\n                                \"variable_list\": [],\n                                \"main_task_local_reference\": {\n                                    \"kind\": \"app_task\",\n                                    \"uuid\": _uuid[13]\n                                },\n                                \"task_definition_list\": [\n                                    {\n                                        \"name\": \"%s_dag\"%(_uuid[13].split(\"-\")[-1]),\n                                        \"target_any_local_reference\": {\n                                            \"kind\": \"app_service\",\n                                            \"uuid\": _uuid[9]\n                                        },\n                                        \"variable_list\": [],\n                                        \"child_tasks_local_reference_list\": [],\n                                        \"type\": \"DAG\",\n                                        \"attrs\": {\n                                            \"edges\": []\n                                        },\n                                        \"uuid\": _uuid[13]\n                                    }\n                                ],\n                                \"uuid\": _uuid[14]\n                            },\n                            \"type\": \"system\",\n                            \"uuid\": _uuid[15]\n                        },\n                        {\n                            \"name\": \"action_start\",\n                            \"runbook\": {\n                                \"name\": \"%s_runbook\"%(_uuid[16].split(\"-\")[-1]),\n                                \"variable_list\": [],\n                                \"main_task_local_reference\": {\n                                    \"kind\": \"app_task\",\n                                    \"uuid\": _uuid[16]\n                                },\n                                \"task_definition_list\": [\n                                    {\n                                        \"name\": \"%s_dag\"%(_uuid[16].split(\"-\")[-1]),\n                                        \"target_any_local_reference\": {\n                                            \"kind\": \"app_service\",\n                                            \"uuid\": _uuid[9]\n                                        },\n                                        \"variable_list\": [],\n                                        \"child_tasks_local_reference_list\": [],\n                                        \"type\": \"DAG\",\n                                        \"attrs\": {\n                                            \"edges\": []\n                                        },\n                                        \"uuid\": _uuid[16]\n                                    }\n                                ],\n                                \"uuid\": _uuid[17]\n                            },\n                            \"type\": \"system\",\n                            \"uuid\": _uuid[18]\n                        },\n                        {\n                            \"name\": \"action_stop\",\n                            \"runbook\": {\n                                \"name\": \"%s_runbook\"%(_uuid[19].split(\"-\")[-1]),\n                                \"variable_list\": [],\n                                \"main_task_local_reference\": {\n                                    \"kind\": \"app_task\",\n                                    \"uuid\": _uuid[19]\n                                },\n                                \"task_definition_list\": [\n                                    {\n                                        \"name\": \"%s_dag\"%(_uuid[19].split(\"-\")[-1]),\n                                        \"target_any_local_reference\": {\n                                            \"kind\": \"app_service\",\n                                            \"uuid\": _uuid[9]\n                                        },\n                                        \"variable_list\": [],\n                                        \"child_tasks_local_reference_list\": [],\n                                        \"type\": \"DAG\",\n                                        \"attrs\": {\n                                            \"edges\": []\n                                        },\n                                        \"uuid\": _uuid[19]\n                                    }\n                                ],\n                                \"uuid\": _uuid[20]\n                            },\n                            \"type\": \"system\",\n                            \"uuid\": _uuid[21]\n                        },\n                        {\n                            \"name\": \"action_restart\",\n                            \"runbook\": {\n                                \"name\": \"%s_runbook\"%(_uuid[22].split(\"-\")[-1]),\n                                \"variable_list\": [],\n                                \"main_task_local_reference\": {\n                                    \"kind\": \"app_task\",\n                                    \"uuid\": _uuid[22]\n                                },\n                                \"task_definition_list\": [\n                                    {\n                                        \"name\": \"%s_dag\"%(_uuid[22].split(\"-\")[-1]),\n                                        \"target_any_local_reference\": {\n                                            \"kind\": \"app_service\",\n                                            \"uuid\": _uuid[9]\n                                        },\n                                        \"variable_list\": [],\n                                        \"child_tasks_local_reference_list\": [],\n                                        \"type\": \"DAG\",\n                                        \"attrs\": {\n                                            \"edges\": []\n                                        },\n                                        \"uuid\": _uuid[22]\n                                    }\n                                ],\n                                \"uuid\": _uuid[23]\n                            },\n                            \"type\": \"system\",\n                            \"uuid\": _uuid[24]\n                        }\n                    ],\n                    \"uuid\": _uuid[9]\n                }\n            ],\n            \"credential_definition_list\": [\n                {\n                    \"name\": \"test\",\n                    \"type\": \"PASSWORD\",\n                    \"cred_class\": \"static\",\n                    \"username\": \"admin\",\n                    \"secret\": {\n                        \"attrs\": {\n                            \"is_secret_modified\": True\n                        },\n                        \"value\": \"ssl12345\"\n                    },\n                    \"uuid\": _uuid[4]\n                }\n            ],\n            \"default_credential_local_reference\": {\n                \"kind\": \"app_credential\",\n                \"uuid\": _uuid[4],\n                \"name\": \"default_credential\"\n            }\n        },\n        \"name\": params[\"blueprint_name\"]\n    }})\n\ndef create_blueprint(**params):\n    payload = get_spec(**params)\n    url = _build_url(scheme=\"https\",\n                    resource_type=\"\/blueprints\")\n    data = requests.post(url, json=payload,\n                        auth=HTTPBasicAuth(pc_user,pc_password),\n                        timeout=None, verify=False)\n    wait_for_completion(data)\n    print(\"bp_uuid={}\".format(data.json()['metadata']['uuid']))\n    \ndef wait_for_completion(data):\n    if data.ok:\n        state = data.json()['status'].get('state')\n        while state == \"PENDING\":\n            _uuid = data.json()['status']['execution_context']['task_uuid']\n            url = _build_url(scheme=\"https\",\n                             resource_type=\"\/tasks\/%s\"%_uuid)\n            responce = requests.get(url, auth=HTTPBasicAuth(pc_user, pc_password),\n                                    verify=False)                      \n            if responce.json()['status'] in ['PENDING', 'RUNNING', 'QUEUED']:\n                state = 'PENDING'\n                sleep(5)                \n            elif responce.json()['status'] == 'FAILED':\n                print(\"Error occured ---> \",data.json().get('message_list', \n                                        data.json().get('error_detail', data.json())))\n                state = 'FAILED'\n                exit(1)\n            else:\n                state = \"COMPLETE\"\n    else:\n        print(\"Error occured ---> \",data.json().get('message_list', \n                                data.json().get('error_detail', data.json())))\n        exit(1)\n\nparams = {\n    \"project_uuid\" : \"@@{project_uuid}@@\",\n    \"environment\": \"@@{environment_uuid}@@\",\n    \"account_uuid\":\"@@{account_uuid}@@\",  # NTNX_LOCAL_AZ\n    \"cluster_uuid\":\"@@{cluster_uuid}@@\",\n    \"subnet_uuid\": \"@@{subnet_uuid}@@\",\n    \"vm_name\":\"VM_@@{app_name}@@\",\n    \"image_uuid\":\"@@{image_uuid}@@\",\n    \"blueprint_name\":\"@@{blueprint_name}@@\"\n}\n\ncreate_blueprint(**params)","eval_variables":["protection_policy_uuid","protection_rule_uuid","bp_spec_uuid","bp_uuid"],"eval_scope":"local","type":"","script_type":"static"},"timeout_secs":"0","type":"SET_VARIABLE","variable_list":[]},{"retries":"0","description":"","inherit_target":false,"child_tasks_local_reference_list":[],"name":"Launch BP","attrs":{"script":"# script\nimport requests\nfrom requests.auth import HTTPBasicAuth\n\nPC_IP = \"@@{PC_IP}@@\"\npc_user = \"@@{prism_central_username}@@\"\npc_password = \"@@{prism_central_passwd}@@\"\n\ndef _build_url(scheme, resource_type, host=PC_IP, **params):\n    _base_url = \"\/api\/nutanix\/v3\"\n    url = \"{proto}:\/\/{host}\".format(proto=scheme, host=host)\n    port = params.get('nutanix_port', '9440')\n    if port:\n        url = url + \":{0}\".format(port) + _base_url\n    if resource_type.startswith(\"\/\"):\n        url += resource_type\n    else:\n        url += \"\/{0}\".format(resource_type)\n    return url\n\ndef get_spec(app_profile_uuid,app_name,app_description):\n    return ({\n            \"spec\": {\n                \"app_profile_reference\": {\n                    \"kind\": \"app_profile\",\n                    \"uuid\": app_profile_uuid\n                },\n            \"app_description\": app_description,\n            \"app_name\": app_name\n            }\n          })\n\ndef launch_blueprint(**params):\n    url = _build_url(scheme=\"https\",\n                    resource_type=\"\/blueprints\/%s\"%params['bp_uuid'])\n    data = requests.get(url, auth=HTTPBasicAuth(pc_user,pc_password),verify=False)\n    if data.ok:\n        app_profile_uuid = data.json()[\"spec\"][\"resources\"][\"app_profile_list\"][0][\"uuid\"]\n    else:\n        print(\"Error while fetching Blueprint with UUID - %s \"%params['bp_uuid'])\n        exit(1)\n        \n    payload = get_spec(app_profile_uuid,\n                       app_name=params[\"application_name\"],\n                       app_description=params[\"application_name\"])\n    \n    url = _build_url(scheme=\"https\",\n                    resource_type=\"\/blueprints\/%s\/simple_launch\"%params['bp_uuid'])\n    data = requests.post(url, json=payload,\n                        auth=HTTPBasicAuth(pc_user,pc_password),\n                        timeout=None, verify=False)\n    wait_for_completion(data)\n    \ndef wait_for_completion(data):\n    if data.ok:\n        _uuid = data.json()['status'][\"request_id\"]\n        print(\"Request_Id={}\".format(_uuid))\n        state = \"PENDING\"\n        while state == \"PENDING\":\n            url = _build_url(scheme=\"https\",\n                             resource_type=\"\/tasks\/%s\"%_uuid)\n            responce = requests.get(url, auth=HTTPBasicAuth(pc_user, pc_password),\n                                    verify=False)                      \n            if responce.json()['status'] in ['PENDING', 'RUNNING', 'QUEUED']:\n                state = 'PENDING'\n                sleep(5)                \n            elif responce.json()['status'] == 'FAILED':\n                print(\"Error occured ---> \",data.json().get('message_list', \n                                        data.json().get('error_detail', data.json())))\n                state = 'FAILED'\n                exit(1)\n            else:\n                state = \"COMPLETE\"\n    else:\n        print(\"Error occured ---> \",data.json().get('message_list', \n                                data.json().get('error_detail', data.json())))\n        exit(1)\n\nparams = {\n    \"project_uuid\" : \"@@{project_uuid}@@\",\n    \"environment\": \"@@{environment_uuid}@@\",\n    \"account_uuid\":\"@@{account_uuid}@@\",  # NTNX_LOCAL_AZ\n    \"cluster_uuid\":\"@@{cluster_uuid}@@\",\n    \"subnet_uuid\": \"@@{subnet_uuid}@@\",\n    \"vm_name\":\"VM_@@{app_name}@@\",\n    \"image_uuid\":\"@@{image_uuid}@@\",\n    \"blueprint_name\":\"@@{blueprint_name}@@\",\n    #\"protection_policy_uuid\":\"@@{protection_policy_uuid}@@\",\n    #\"protection_rule_uuid\":\"@@{protection_rule_uuid}@@\",\n    \"bp_uuid\":\"@@{bp_uuid}@@\",\n    \"application_name\":\"@@{app_name}@@\"\n}\nlaunch_blueprint(**params)","type":"","command_line_args":"","exit_status":[],"script_type":"static"},"timeout_secs":"0","type":"EXEC","variable_list":[]}],"description":"","name":"e8d48d56_runbook","main_task_local_reference":{"kind":"app_task","name":"a0c17627_dag"},"variable_list":[{"val_type":"STRING","is_mandatory":true,"description":"","data_type":"BASE","type":"LOCAL","name":"app_name","value":"SP_App","label":"APP Name","attrs":{"type":""},"editables":{"value":true},"is_hidden":false,"options":{"type":"PREDEFINED","choices":[]}},{"val_type":"STRING","is_mandatory":true,"description":"","data_type":"BASE","type":"LOCAL","name":"blueprint_name","value":"SP_BP","label":"Blueprint Name","attrs":{"type":""},"editables":{"value":true},"is_hidden":false,"options":{"type":"PREDEFINED","choices":[]}},{"val_type":"STRING","is_mandatory":true,"description":"","data_type":"BASE","type":"LOCAL","name":"project_name","value":"Nutanix_SP_project","label":"Project Name for App Creation","attrs":{"type":""},"editables":{"value":true},"is_hidden":false,"options":{"type":"PREDEFINED","choices":[]}},{"val_type":"STRING","is_mandatory":true,"description":"","data_type":"BASE","type":"LOCAL","name":"account_name","value":"NTNX_LOCAL_AZ","label":"Account Name","attrs":{"type":""},"editables":{"value":true},"is_hidden":false,"options":{"type":"PREDEFINED","choices":[]}},{"val_type":"STRING","is_mandatory":true,"description":"Project environment name for BP and App protection policy.","data_type":"BASE","type":"LOCAL","name":"environment_name","value":"Nutanix_SP_project_Environment","label":"Environment Name","attrs":{"type":""},"editables":{"value":true},"is_hidden":false,"options":{"type":"PREDEFINED","choices":[]}},{"val_type":"STRING","is_mandatory":true,"description":"Should be in json format. IE. {\"Key\":\"Value\"}","data_type":"BASE","type":"LOCAL","name":"tenant_category","value":"{\"TenantName\":\"Nutanix_SP\"}","label":"Tenant Category for APP VM","attrs":{"type":""},"editables":{"value":true},"is_hidden":false,"options":{"type":"PREDEFINED","choices":[]}},{"val_type":"STRING","is_mandatory":true,"description":"","data_type":"BASE","type":"LOCAL","name":"cluster_name","value":"ceres-ahv","label":"Cluster Name","attrs":{"type":"LOCAL"},"editables":{"value":true},"is_hidden":false,"options":{"type":"PREDEFINED","choices":[]}},{"val_type":"STRING","is_mandatory":true,"description":"","data_type":"BASE","type":"LOCAL","name":"vm_os","value":"Linux","label":"App VM OS Type","attrs":{"type":"LOCAL"},"editables":{"value":true},"is_hidden":false,"options":{"type":"PREDEFINED","choices":["Linux","Windows"]}},{"val_type":"STRING","is_mandatory":true,"description":"","data_type":"BASE","type":"LOCAL","name":"image_name","value":"Centos7HadoopMaster.qcow2","label":"Image Name for APP Creation","attrs":{"type":""},"editables":{"value":true},"is_hidden":false,"options":{"type":"PREDEFINED","choices":[]}},{"regex":{"should_validate":false,"value":"^[\\d]*$"},"val_type":"INT","is_mandatory":true,"description":"","data_type":"BASE","type":"LOCAL","name":"vm_memory","value":"2","label":"App VM Memory in GB","attrs":{"type":""},"editables":{"value":true},"is_hidden":false,"options":{"type":"PREDEFINED","choices":[]}},{"regex":{"should_validate":false,"value":"^[\\d]*$"},"val_type":"INT","is_mandatory":true,"description":"","data_type":"BASE","type":"LOCAL","name":"vm_vcpus","value":"2","label":"Number of App VM VCPUs","attrs":{"type":""},"editables":{"value":true},"is_hidden":false,"options":{"type":"PREDEFINED","choices":[]}},{"val_type":"STRING","is_mandatory":true,"description":"","data_type":"BASE","type":"LOCAL","name":"subnet_name","value":"Nutanix_SP_Overlay_Subnet","label":"Subnet Name for APP VM","attrs":{"type":""},"editables":{"value":true},"is_hidden":false,"options":{"type":"PREDEFINED","choices":[]}},{"val_type":"STRING","is_mandatory":false,"description":"Provide IP if static IP for application VM needed, otherwise IP will be selected using DHCP.","data_type":"BASE","type":"LOCAL","name":"custom_ip_for_vm","value":"10.10.40.6","label":"Custom IP for VM","attrs":{"type":""},"editables":{"value":true},"is_hidden":false,"options":{"type":"PREDEFINED","choices":[]}},{"val_type":"STRING","is_mandatory":true,"description":"","data_type":"BASE","type":"LOCAL","name":"PC_IP","value":"10.42.244.10","label":"PC IP","attrs":{"type":""},"editables":{"value":true},"is_hidden":false,"options":{"type":"PREDEFINED","choices":[]}},{"val_type":"STRING","is_mandatory":false,"description":"","data_type":"BASE","type":"SECRET","name":"prism_central_username","value":"rCZjB5C+P0wdRX\/KlQ6T4f6OvGNAY6dYl8nyv\/GyoZGDwsge\/A==:utf-8","label":"Prism Central UserName","attrs":{"is_secret_modified":false,"secret_reference":{},"type":"SECRET"},"is_hidden":false,"options":{"type":"PREDEFINED","choices":[]}},{"val_type":"STRING","is_mandatory":false,"description":"","data_type":"BASE","type":"SECRET","name":"prism_central_passwd","value":"p9jgp2YoLqD0EXStIgrcgX25GudyXr9VRvdkfMWxmW2YFIVLLS6TZLHGCA==:utf-8","label":"Prism Central Password","attrs":{"is_secret_modified":false,"secret_reference":{},"type":"SECRET"},"is_hidden":false,"options":{"type":"PREDEFINED","choices":[]}}]}},"name":"Single VM Blueprint"},"api_version":"3.0","metadata":{"last_update_time":"1660706143849541","kind":"runbook","spec_version":12,"creation_time":"1660105543375882","name":"Single VM Blueprint"}}