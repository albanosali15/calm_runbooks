{"status":{},"contains_secrets":true,"product_version":"3.5.2","spec":{"description":"","resources":{"endpoints_information":[],"endpoint_definition_list":[],"client_attrs":{},"credential_definition_list":[],"runbook":{"task_definition_list":[{"retries":"0","description":"","inherit_target":false,"child_tasks_local_reference_list":[{"kind":"app_task","name":"Test Failover "}],"name":"702b66b7_dag","attrs":{"edges":[],"type":""},"timeout_secs":"0","type":"DAG","variable_list":[]},{"retries":"0","description":"","inherit_target":false,"child_tasks_local_reference_list":[],"name":"Test Failover ","attrs":{"script":"# script\nimport requests\nfrom requests.auth import HTTPBasicAuth\n\nPC_IP = \"@@{PC_IP}@@\"\npc_user = \"@@{prism_central_username}@@\"\npc_password = \"@@{prism_central_passwd}@@\"\n\ndef _build_url(scheme, resource_type, host=PC_IP, **params):\n    _base_url = \"\/api\/nutanix\/v3\"\n    url = \"{proto}:\/\/{host}\".format(proto=scheme, host=host)\n    port = params.get('nutanix_port', '9440')\n    if port:\n        url = url + \":{0}\".format(port) + _base_url\n    if resource_type.startswith(\"\/\"):\n        url += resource_type\n    else:\n        url += \"\/{0}\".format(resource_type)\n    return url\n    \ndef wait_for_completion(data):\n    if data.ok:\n        print(\"Test in progress ..\",end=\"\")\n        state = \"PENDING\"\n        while state == \"PENDING\":\n            print(\".\",end=\"\")\n            _uuid = data.json()['api_response_list'][0]['api_response']['task_uuid']\n            url = _build_url(scheme=\"https\",\n                             resource_type=\"\/tasks\/%s\"%_uuid)\n            responce = requests.get(url, auth=HTTPBasicAuth(pc_user, pc_password),\n                                    verify=False)                      \n            if responce.json()['status'] in ['PENDING', 'RUNNING', 'QUEUED']:\n                state = 'PENDING'\n                sleep(5)                \n            elif responce.json()['status'] == 'FAILED':\n                print(\"Error occured ---> \",responce.json().get('message_list', \n                                            responce.json().get('error_detail', responce.json())))\n                state = 'FAILED'\n                exit(1)\n            else:\n                state = \"COMPLETE\"\n    else:\n        print(\"Error occured ---> \",data.json().get('message_list', \n                                data.json().get('error_detail', data.json())))\n        exit(1)\n\ndef get_spec(**params):\n    return (\n    {\"action_on_failure\": \"CONTINUE\",\n    \"execution_order\": \"NON_SEQUENTIAL\",\n    \"api_request_list\": [\n        {\n            \"operation\": \"POST\",\n            \"path_and_params\": \"\/api\/nutanix\/v3\/recovery_plan_jobs\",\n            \"body\": {\n                \"spec\": {\n                    \"name\": \"Test Failover - @@{calm_now}@@\",\n                    \"resources\": {\n                        \"recovery_plan_reference\": {\n                            \"kind\": \"recovery_plan\",\n                            \"name\": params[\"recovery_plan_name\"],\n                            \"uuid\": params[\"recovery_plan_uuid\"]\n                        },\n                        \"execution_parameters\": {\n                            \"action_type\": \"TEST_FAILOVER\",\n                            \"failed_availability_zone_list\": [\n                                {\n                                    \"availability_zone_url\": params[\"failed_availability_zone_uuid\"]\n                                }\n                            ],\n                            \"recovery_availability_zone_list\": [\n                                {\n                                    \"availability_zone_url\": params[\"recovery_availability_zone_uuid\"]\n                                }\n                            ],\n                            \"should_continue_on_validation_failure\": True\n                        }\n                    }\n                },\n                \"metadata\": {\n                    \"kind\": \"recovery_plan_job\"\n                },\n                \"api_version\": \"3.1.0\"\n            }}],\n            \"api_version\": \"3.1.0\"\n        })\n\ndef test_failover(**params):\n    payload = get_spec(**params)\n    url = _build_url(scheme=\"https\",\n                    resource_type=\"\/batch\")\n    data = requests.post(url, json=payload,\n                        auth=HTTPBasicAuth(pc_user,pc_password),\n                        timeout=None, verify=False)\n    if not data.ok:\n        print(\"Error :- \",data.json())\n        exit(1)\n        \n    wait_for_completion(data)\n    print(\"%s recovery plan tested successfully, Its working as \"\\\n                          \"expected.\"%params[\"recovery_plan_name\"])\n    \ndef get_account_info(account_name):\n    url = _build_url(scheme=\"https\",resource_type=\"\/accounts\/list\")\n    data = requests.post(url, json={\"kind\":\"account\", \"filter\":\"name==%s\"%account_name},\n                        auth=HTTPBasicAuth(pc_user,pc_password),\n                        timeout=None, verify=False)\n    if len(data.json()['entities']) == 1:\n        pc_account_uuid = data.json()['entities'][0]['status']\\\n                        ['resources']['data']['pc_uuid']\n        return pc_account_uuid\n    else:\n        print(\"Got Error while getting account info %s\"%account_name)\n        print(\"Please make sure account name is correct and account is active.\")\n        exit(1)\n        \ndef recovery_plan_info(plan_name):\n    url = _build_url(scheme=\"https\",resource_type=\"\/recovery_plans\/list\")\n    data = requests.post(url, json={\"kind\":\"recovery_plan\", \"filter\":\"name==%s\"%plan_name},\n                        auth=HTTPBasicAuth(pc_user,pc_password),\n                        timeout=None, verify=False)\n    if len(data.json()['entities']) != 0:\n        recovery_plan_uuid = data.json()[\"entities\"][0][\"metadata\"][\"uuid\"]\n        return recovery_plan_uuid\n    else:\n        print(\"Got Error while fetching recovery plan info - %s\"%plan_name)\n        print(\"Please make sure recovery plan name is correct and active.\")\n        exit(1)\n\nparams = {\"recovery_plan_name\":\"@@{recovery_plan_name}@@\".strip(),\n          \"recovery_plan_uuid\":recovery_plan_info(\"@@{recovery_plan_name}@@\".strip()),\n          \"failed_availability_zone_uuid\":get_account_info(\"@@{account_name_failing_over_from}@@\".strip()),\n          \"recovery_availability_zone_uuid\":get_account_info(\"@@{account_name_failing_over_to}@@\".strip())\n         }\ntest_failover(**params)","type":"","command_line_args":"","exit_status":[],"script_type":"static"},"timeout_secs":"0","type":"EXEC","variable_list":[]}],"description":"","name":"2619242e_runbook","main_task_local_reference":{"kind":"app_task","name":"702b66b7_dag"},"variable_list":[{"val_type":"STRING","is_mandatory":true,"description":"","data_type":"BASE","type":"LOCAL","name":"recovery_plan_name","value":"Test","label":"Recovery Plan Name","attrs":{"type":""},"editables":{"value":true},"is_hidden":false,"options":{"type":"PREDEFINED","choices":[]}},{"val_type":"STRING","is_mandatory":true,"description":"Calm Account Name of Remote PC's Cluster on Local PC.","data_type":"BASE","type":"LOCAL","name":"account_name_failing_over_from","value":"NTNX_LOCAL_AZ","label":"Account Name of Entity Failing Over From","attrs":{"type":""},"editables":{"value":true},"is_hidden":false,"options":{"type":"PREDEFINED","choices":[]}},{"val_type":"STRING","is_mandatory":true,"description":"Calm Account Name of Local PC","data_type":"BASE","type":"LOCAL","name":"account_name_failing_over_to","value":"DR_76_78","label":"Account Name of Entity Failing Over To","attrs":{"type":""},"editables":{"value":true},"is_hidden":false,"options":{"type":"PREDEFINED","choices":[]}},{"val_type":"STRING","is_mandatory":true,"description":"","data_type":"BASE","type":"LOCAL","name":"PC_IP","value":"10.44.77.68","label":"Prism Central IP","attrs":{"type":""},"editables":{"value":true},"is_hidden":false,"options":{"type":"PREDEFINED","choices":[]}},{"val_type":"STRING","is_mandatory":true,"description":"","data_type":"BASE","type":"SECRET","name":"prism_central_passwd","value":"U94TsTcW6czNp32EdZDq30kGr0xDKIlSA6r81vEHtzD49OjePYEr8aXz+g==:utf-8","label":"Prism Central Password","attrs":{"is_secret_modified":false,"secret_reference":{},"type":"SECRET"},"editables":{"value":false},"is_hidden":false,"options":{"type":"PREDEFINED","choices":[]}},{"val_type":"STRING","is_mandatory":true,"description":"","data_type":"BASE","type":"SECRET","name":"prism_central_username","value":"KF0\/1HrFTNAQtVfgR0uOXMzVT1oSUBAOWFvhoddV1YcQdDKstw==:utf-8","label":"Prism Central Username","attrs":{"is_secret_modified":false,"secret_reference":{},"type":"SECRET"},"editables":{"value":false},"is_hidden":false,"options":{"type":"PREDEFINED","choices":[]}}]}},"name":"Test Failover"},"api_version":"3.0","metadata":{"last_update_time":"1660739786120482","kind":"runbook","spec_version":3,"creation_time":"1660738679626412","name":"Test Failover"}}